<!DOCTYPE html>
<html lang="en">
	
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
	<title>Two Column Layout</title>
	<link rel="stylesheet" type="text/css" href="css/general.css" />
	<link rel="stylesheet" type="text/css" href="css/layout.css" />
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<link rel="stylesheet" type="text/css" href="elements/actionbar/actionbar.css" />
	<link rel="stylesheet" type="text/css" href="elements/shiftbox/shiftbox.css" />
	<link rel="stylesheet" type="text/css" href="elements/slidebox/slidebox.css" />
	<link rel="stylesheet" type="text/css" href="elements/flipbox/flipbox.css" />
	<link rel="stylesheet" type="text/css" href="elements/modal/modal.css" />

	

	<style type="text/css">
		x-template{
			display: none;
		}
	</style>
	
	<x-template name="todo-item-list">
		<script type="template/script">
				this.addTemplateListeners({
					'click:delegate(.edit)': function(e){
						console.log("edit clicked");
						var node = document.createElement('x-todo-item');
						node.pk = e.templateTarget.pk;
						node.template = 'todo-item-edit';	
						node.xtag.entityData = e.templateTarget.xtag.entityData;					
						Layout.setDetail(node);
					}, 
					'click:delegate(.completed)': function(e){
						console.log(e.customElement, this);
						alert("THIS IS MESSED UP.  e.customELement should be x-todo-item");
					}
				});
		</script>
		<script type="template/content">
			<h3>{title}</h3>
			<ul>
				<li>{date}</li>
				<li>{starred}</li>
				<li>{completed}</li>
			</ul>
			<ul>
				<li><a href="#" class="edit">edit</a></li>
				<li><a href="#" class="completed">completed</a></li>
			</ul>
		</script>
	</x-template>

	<x-template name="todo-item-detail">
		<script type="template/content">
			<h3>{title}</h3>
			<p>{description}</p>
			<ul><li>{date}</li><li>{starred}</li><li>{completed}</li></ul>
		</script>
	</x-template>

	<x-template name="todo-item-edit">
		<script type="template/script">
				this.addTemplateListeners({
					'click:delegate(.save)': function(e){
						var newTodo = { 
							starred: false,
							completed: false, 
							date: new Date() 
						};
						//how to check if this is an updated, vs new
						xtag.query(this.parentNode, 'input').forEach(function(input){
							newTodo[input.name] = input.value;
						});
						for (var key in newTodo){
							xtag.fireEvent(this.parentNode, 'datapropertychanged', 
								{ dataProperty: { key: key, value: newTodo[key] }});
						}
						document.getElementsByTagName('x-todo-list')[0].refresh();
						Layout.home();
					}
				});
		</script>
		<script type="template/content">
			<p>
				<label for="todo-title">Title</label>
				<input name="title" type="text" value="{title}"/>
			</p>
			<p>
				<label for="todo-description">Description</label>
				<input name="description" value="{description}" />
			</p>
			<button class="save">Save</button>
		</script>
	</x-template>

</head>

<body>

	<x-localstorage id="todoItems" for="x-todo-item" path="todoapp/todoItem">
		<x-property key="title"></x-property>
		<x-property key="description"></x-property>
		<x-property key="date"></x-property>
		<x-property key="starred"></x-property>
		<x-property key="completed"></x-property>
	</x-localstorage>
	

	<div id="app" class="flex-stack">

		<header id="header" class="flex-line flex-zero">
			<div id="global_actions_trigger" class="flex-zero"></div>
			<div id="logo" class="flex-line flex-zero">
				<img src="images/logo.png"/>
			</div>
			<div id="wordmark" class="flex-line flex-center">
				<span>Basic App</span>
			</div>
			<x-actionbar id="global_actions" data-mode="full">			
				<x-action label="New Todo" data-action='new' icon="images/pencil.png"></x-action>
				<x-action label="Settings" data-action='settings' icon="images/equalizer.png"></x-action>
			</x-actionbar>
		</header>
		
		<section>	
			<x-shiftbox id="content">
			
				<x-actionbar id="global_menu">
					<x-action label="All" data-action='active' icon="images/pencil.png" selected></x-action>
					<x-action label="Starred" data-action='starred' icon="images/pencil.png"></x-action>
					<x-action label="Done" data-action='completed' icon="images/pencil.png"></x-action>
				</x-actionbar>
				
				<x-shift>
					<x-slidebox id="slidebox">
						<x-slides id="views">
						
							<x-slide class="list" selected>							
								<x-todo-list id="list" for="todoItems" query="{ 'completed': false }">
								</x-todo-list>
							</x-slide>

							<x-slide class="detail">
								<x-flipbox id="flipbox">
									<x-card>
										<div id="detail">

										</div>
										<div id="history">
											<h2>History</h2>
											<ul>
												<li>08:30 - created</li>
												<li>08:35 - starred</li>
												<li>08:55 - completed</li>
											</ul>
										</div>
									</x-card>
								</x-flipbox>
							</x-slide>
						</x-slides>
					</x-slidebox>
				</x-shift>
			</x-shiftbox>
		</section>
		
		<footer id="footer" class="flex-line flex-zero">
			
		</footer>

	</div>

	

	<x-mediaquery 
		id="small_desktop"
		for="app"
		media="only screen and (max-width: 520px)">
	</x-mediaquery>

	<x-mediaquery 
		id="med_desktop"
		for="app"
		media="only screen and (min-width: 520px) and (max-width: 920px)">
	</x-mediaquery>

	<x-mediaquery 
		id="large_desktop"
		for="app"
		media="only screen and (min-width: 921px)">
	</x-mediaquery>

	<x-mediaquery 
		id="tablet"
		for="app"
		media="only screen and (min-device-width: 801px) and (max-device-width : 1200px)">
	</x-mediaquery>

	<x-mediaquery 
		id="phone_portrait"
		for="app"
		media="only screen and (max-device-width : 480px) and (orientation: portrait)">
	</x-mediaquery>

	<x-mediaquery 
		id="phone_landscape"
		for="app"
		media="only screen and (min-device-width : 481px) and (max-device-width : 800px) and (orientation: landscape)">
	</x-mediaquery>

</body>

<script type="text/javascript" src="js/x-tag.js"></script>
	<script type="text/javascript" src="js/list-view.js"></script>
	<script type="text/javascript" src="elements/actionbar/actionbar.js"></script>	
	<script type="text/javascript" src="elements/flipbox/flipbox.js"></script>
	<script type="text/javascript" src="elements/mediaquery/mediaquery.js"></script>
	<script type="text/javascript" src="elements/modal/modal.js"></script>
	<script type="text/javascript" src="elements/shiftbox/shiftbox.js"></script>
	<script type="text/javascript" src="elements/slidebox/slidebox.js"></script>
	<script type="text/javascript" src="elements/template/template.js"></script>

	<script type="text/javascript" src="js/todo.js"></script>

<script type="text/javascript">

(function(){
	document.addEventListener('DOMComponentsLoaded', function(){

	});

	xtag.addEvent(xtag.query(document, '#global_menu')[0], 'command', function(e){
		console.log("command", e.target.dataset.action);
		var todoList = xtag.query(document, 'x-todo-list')[0];
		
		switch(e.target.dataset.action){
			case 'active':
				todoList.query = '{ "completed": false }';
				break;
			case 'starred':
				todoList.query = '{ "starred": true }';
				break;
			case 'completed':
				todoList.query = '{ "completed": true }';
				break;
		}
	});

	xtag.addEvent(xtag.query(document, '#global_actions')[0], 'command', function(e){

		switch(e.target.dataset.action){
			case 'new':
				var item = document.createElement('x-todo-item');
				item.template = 'todo-item-edit';
				Layout.setDetail(item);
				break;
			case 'settings':
				Layout.showSettings();
				break;
		}
	});

	xtag.addEvent(xtag.query(document, "#list" )[0], 'click:delegate(x-todo-item)', function(e){
		
		if (~['A', 'LI'].indexOf(e.target.nodeName)) return;

		var selected = document.createElement('x-todo-item');		
		selected.dataset.pk = this.dataset.pk;
		selected.xtag.entityData = this.xtag.entityData;
		selected.template = 'todo-item-detail';

		var currentDetail = document.getElementById('detail').children[0];
		if (!currentDetail || currentDetail.pk != this.pk || currentDetail.template != selected.template){
			history.pushState(null, null, "#" + this.dataset.pk);
			Layout.setDetail(selected);
		}
		
	});

})();

	
</script>
	
</html>